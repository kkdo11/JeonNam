<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지 - 전남 영화/드라마 여행</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 50px;
            background-color: #f8f9fa;
        }
        .mypage-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .info-row {
            margin-bottom: 10px;
        }
        .info-label {
            font-weight: bold;
            color: #495057;
        }
    </style>
</head>
<body>
<div class="container mypage-container">
    <h2 class="text-center mb-4">마이페이지</h2>

    <h3 class="mb-3">내 정보</h3>
    <div th:if="${userInfo}" class="mb-4">
        <div class="row info-row">
            <div class="col-4 info-label">이메일:</div>
            <div class="col-8" th:text="${userInfo.email}"></div>
        </div>
        <div class="row info-row">
            <div class="col-4 info-label">이름:</div>
            <div class="col-8" th:text="${userInfo.name}"></div>
        </div>
        <div class="row info-row">
            <div class="col-4 info-label">생년월일:</div>
            <div class="col-8" th:text="${userInfo.birthDate}"></div>
        </div>
        <div class="row info-row">
            <div class="col-4 info-label">성별:</div>
            <div class="col-8" th:text="${userInfo.sex == 'M' ? '남성' : (userInfo.sex == 'F' ? '여성' : '기타')}"></div>
        </div>
        <div class="row info-row">
            <div class="col-4 info-label">국가:</div>
            <div class="col-8" th:text="${userInfo.country}"></div>
        </div>
    </div>
    <div th:unless="${userInfo}" class="alert alert-warning text-center" role="alert">
        사용자 정보를 불러올 수 없습니다.
    </div>

    <h3 class="mb-3 mt-5">비밀번호 변경</h3>
    <form id="changePasswordForm">
        <div class="mb-3">
            <label for="currentPassword" class="form-label">현재 비밀번호</label>
            <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
        </div>
        <div class="mb-3">
            <label for="newPassword" class="form-label">새 비밀번호</label>
            <input type="password" class="form-control" id="newPassword" name="newPassword" required>
        </div>
        <div class="mb-3">
            <label for="confirmNewPassword" class="form-label">새 비밀번호 확인</label>
            <input type="password" class="form-control" id="confirmNewPassword" required>
            <div id="newPasswordMatchResult" class="form-text"></div>
        </div>
        <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary" id="changePasswordBtn">비밀번호 변경</button>
        </div>
    </form>
    <div id="changePasswordResult" class="mt-3 text-center"></div>

    <div class="mt-4 text-center">
        <a href="/" class="btn btn-secondary">홈으로 돌아가기</a>
        <a href="/auth/logout" class="btn btn-danger ms-2">로그아웃</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let isNewPasswordMatched = false;

    // 새 비밀번호 일치 확인
    $('#newPassword, #confirmNewPassword').on('keyup', function() {
        const newPassword = $('#newPassword').val();
        const confirmNewPassword = $('#confirmNewPassword').val();

        if (newPassword.length === 0 && confirmNewPassword.length === 0) {
            $('#newPasswordMatchResult').text('');
            isNewPasswordMatched = false;
        } else if (newPassword !== confirmNewPassword) {
            $('#newPasswordMatchResult').text('새 비밀번호가 일치하지 않습니다.').css('color', 'red');
            isNewPasswordMatched = false;
        } else {
            $('#newPasswordMatchResult').text('새 비밀번호가 일치합니다.').css('color', 'green');
            isNewPasswordMatched = true;
        }
    });

    // 비밀번호 변경 요청
    $('#changePasswordBtn').on('click', function() {
        const currentPassword = $('#currentPassword').val();
        const newPassword = $('#newPassword').val();

        if (!currentPassword || !newPassword) {
            $('#changePasswordResult').text('현재 비밀번호와 새 비밀번호를 모두 입력해주세요.').css('color', 'red');
            return;
        }
        if (!isNewPasswordMatched) {
            $('#changePasswordResult').text('새 비밀번호와 확인 비밀번호가 일치하지 않습니다.').css('color', 'red');
            return;
        }
        if (currentPassword === newPassword) {
            $('#changePasswordResult').text('새 비밀번호는 현재 비밀번호와 다르게 설정해야 합니다.').css('color', 'red');
            return;
        }

        $.ajax({
            url: '/account/changePassword', // 변경된 경로
            type: 'POST',
            contentType: 'application/json', // JSON 형식으로 데이터 전송 명시
            data: JSON.stringify({ currentPassword: currentPassword, newPassword: newPassword }), // JSON 문자열로 변환
            dataType: 'json',
            success: function(response) {
                if (response.result === 1) {
                    $('#changePasswordResult').text(response.msg).css('color', 'green');
                    // 성공 시 폼 초기화 또는 로그인 페이지로 리다이렉트 권장
                    $('#changePasswordForm')[0].reset();
                    // 비밀번호 변경 후 로그아웃하여 다시 로그인하도록 유도
                    setTimeout(function() {
                        alert("비밀번호가 변경되었습니다. 다시 로그인해주세요.");
                        window.location.href = '/user/login?passwordChanged=true'; // UserInfoViewController의 loginPage로 연결
                    }, 1500);
                } else {
                    $('#changePasswordResult').text(response.msg).css('color', 'red');
                }
            },
            error: function(xhr, status, error) {
                $('#changePasswordResult').text('비밀번호 변경 중 오류가 발생했습니다.').css('color', 'red');
                console.error("비밀번호 변경 오류:", status, error);
            }
        });
    });
</script>
</body>
</html>